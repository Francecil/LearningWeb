# 背景知识

## 对称加密

加密秘钥和解密秘钥相同，加解密速度比非对称加密快

常用算法： DES ,AES

## 非对称加密

公钥公开，私钥保密，客户端公钥加密数据，服务端私钥解密数据



常用算法： RSA

# https 传输过程

过程如图所示

![](https://ask.qcloudimg.com/http-save/yehe-2797993/gc5fr601ul.png?imageView2/2/w/1620)

## 1 客户端发起请求

## 2 服务端配置

服务端配置了公钥（证书信息），私钥

## 3 传送证书

包含了证书颁发机构，过期时间等信息

## 4 解析证书

验证该证书是否有效，
> 怎么验证？
如果异常，出现提示；否则生成一个随机值

用证书对该随机值加密

## 5 传送加密信息

将加密后的随机值传送给服务端，后面的通信都是利用这个随机值来加解密

## 6 服务端解密

服务端用私钥解出随机值，后面的内容将以该值作为加密内容的私钥--对称加密

## 7 传输加密后的信息

## 8 客户端解密信息

# Q&A

## Q1: 为什么还要做一次对称加密

因为公钥（证书）大家都有，如果仅用非对称加密的话，服务端用私钥加密，客户端需要用公钥解密，而由于公钥大家都有，所以服务端响应的数据如果被拦截，是可以被解密然后获取到具体信息

另外一点就是非对称加解密的效率较低

## Q2: 什么是中间人攻击

dns 解析被污染，用户访问的地址指向中间人服务器

tls 建联阶段，中间人服务器拿到服务器返回的证书A，返回给浏览器一个伪造证书B

由于各种原因（这里不展开），浏览器信任了中间人服务器发来的证书B

浏览器通过该证书B 对随机字符串进行公钥加密，并发往中间人服务器

由于中间人服务器有证书B对应的私钥，可以解开得到这个随机字符串，于是将该随机字符串又用证书A加密后，返回给服务器

服务器用私钥解密拿到该随机字符串，并把响应内容通过该随机字符串做对称加密返回

由于中间人知道该随机字符串，故

中间人可以解开浏览器的请求内容以及服务器的响应内容

达到了中间人攻击的效果

## Q3: 中间人攻击时，返回合法证书会怎么样

返回了原服务器的证书，浏览器是会信任该证书，可是由于没有私钥，中间人服务器并解不出由该证书加密的随机字符串，进而也达不到攻击的效果

## Q4: 浏览器怎么验证证书是合法的


- 验证域名，有效期，证书来源
> 有被篡改的可能呀，所以
- 通过 CA 服务器判断证书是否被篡改
> 已经验证过了，每次都得验证么？如何优化？所以
- 通过 CRL 和 OCSP 判断证书是否已吊销，OCSP 可减少与 CA 服务器的交互



# 参考

1. https://cloud.tencent.com/developer/article/1335821
2. [你连 HTTPS 原理都不懂，还讲“中间人攻击”？](https://mp.weixin.qq.com/s/PzgkDyKZPB0rFK90ebT5ow)